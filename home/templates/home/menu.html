<!DOCTYPE html>
<html>
<head>
    <title>Menu - QeydLab</title>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'><rect%20x='2'%20y='3'%20width='14'%20height='18'%20rx='2'%20fill='%23044f8a'/><path%20d='M16.5%203.5l4%204L10%2018l-4%201%201-4%2010.5-11.5z'%20fill='%23fff'/></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root{
            --bg: #f5f6f8;
            --box-bg: #fff;
            --primary: #007BFF;
            --muted: #666;
            --radius: 12px;
        }
        body {
            background-color: var(--bg);
            font-family: Arial, sans-serif;
            color: #222;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }
        .box {
            background: var(--box-bg);
            width: 100%;
            max-width: 1200px;
            border-radius: var(--radius);
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            padding: 22px;
        }
        .header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 24px;
        }
        h1 { margin:0; font-size:24px; color:#004080 }
        .btn { 
            background:var(--primary); 
            color:#fff; 
            border:none; 
            padding:10px 16px; 
            border-radius:8px; 
            cursor:pointer; 
            text-decoration:none; 
            display:inline-flex; 
            align-items:center; 
            gap:8px;
            font-size:14px;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn.secondary { background:#6c757d; text-decoration:none }
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }
        .upload-section:hover {
            border-color: var(--primary);
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .media-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            cursor: pointer;
        }
        .media-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .media-item-wrapper {
            position: relative;
        }
        .media-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 10;
            transition: all 0.2s;
        }
        .media-delete-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }
        .media-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f0f0f0;
            cursor: pointer;
        }
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .fullscreen-modal.active {
            display: flex;
        }
        .fullscreen-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        .fullscreen-content img,
        .fullscreen-content video {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        .fullscreen-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 32px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }
        .notification.error {
            background: #dc3545;
        }
        .notification.active {
            display: flex;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            justify-content: center;
            align-items: center;
        }
        .confirm-modal.active {
            display: flex;
        }
        .confirm-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .confirm-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .confirm-btn.yes {
            background: #dc3545;
            color: white;
        }
        .confirm-btn.no {
            background: #6c757d;
            color: white;
        }
        .media-info {
            padding: 12px;
        }
        .media-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .media-date {
            font-size: 12px;
            color: var(--muted);
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }
        .preview-section {
            margin-top: 20px;
            display: none;
        }
        .preview-section.active {
            display: block;
        }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .preview-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .preview-item-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 10;
        }
        .preview-item-remove:hover {
            background: rgba(220, 53, 69, 1);
        }
        .preview-image, .preview-video {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: #f0f0f0;
        }
        .preview-audio {
            width: 100%;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
        }
        .preview-file {
            width: 100%;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            font-size: 32px;
        }
        .preview-filename {
            padding: 8px;
            font-size: 12px;
            color: #333;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        .selected-files-count {
            margin-top: 12px;
            font-size: 14px;
            color: var(--muted);
        }
        @media (max-width:600px){
            .header { flex-direction:column; align-items:flex-start; gap:10px }
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div style="display:flex; gap:18px; width:100%;">
    {% include 'home/sidebar.html' %}
    <div class="main-with-sidebar">
    <div class="box">
        <div class="header">
            <h1>Menu</h1>
        </div>

        <div class="upload-section">
            <form method="POST" action="{% url 'upload_media' %}" enctype="multipart/form-data" class="upload-form" id="uploadForm">
                {% csrf_token %}
                <div class="file-input-wrapper">
                    <input type="file" name="media_files" id="media_files" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
                    <label for="media_files" class="file-input-label">üìÅ Media fayllarƒ± se√ß</label>
                </div>
                <div class="selected-files-count" id="selectedFilesCount" style="display:none;"></div>
                <button type="submit" class="btn" id="importBtn" style="display:none;">Import et</button>
            </form>
            <div class="preview-section" id="previewSection">
                <h3 style="font-size:16px; margin-bottom:12px; color:#333;">Se√ßilmi≈ü fayllar (Preview):</h3>
                <div class="preview-grid" id="previewGrid"></div>
            </div>
        </div>

        <div>
            <h2 style="font-size:18px; margin-bottom:16px; color:#333;">∆èlav…ô olunan medialar</h2>
            {% if media_list %}
                <div class="media-grid">
                    {% for media in media_list %}
                        <div class="media-item">
                            <div class="media-item-wrapper">
                                {% with file_lower=media.file.name|lower %}
                                    {% if file_lower|slice:"-4:" == '.jpg' or file_lower|slice:"-4:" == '.png' or file_lower|slice:"-4:" == '.gif' or file_lower|slice:"-5:" == '.jpeg' or file_lower|slice:"-5:" == '.webp' %}
                                        <img src="{{ media.file.url }}" alt="{{ media.title }}" class="media-preview" data-media-url="{{ media.file.url }}" data-media-type="image" onerror="this.parentElement.innerHTML='<div class=\'media-preview\' style=\'display:flex; align-items:center; justify-content:center; background:#e0e0e0; font-size:48px;\'>üì∑</div>'">
                                    {% elif file_lower|slice:"-4:" == '.mp4' or file_lower|slice:"-4:" == '.avi' or file_lower|slice:"-4:" == '.mov' or file_lower|slice:"-5:" == '.webm' %}
                                        <video class="media-preview" data-media-url="{{ media.file.url }}" data-media-type="video" controls>
                                            <source src="{{ media.file.url }}" type="video/mp4">
                                        </video>
                                    {% elif file_lower|slice:"-4:" == '.mp3' or file_lower|slice:"-4:" == '.wav' or file_lower|slice:"-4:" == '.ogg' %}
                                        <div class="media-preview" style="display:flex; align-items:center; justify-content:center; background:#e0e0e0;" data-media-type="audio">
                                            <audio controls style="width:100%;">
                                                <source src="{{ media.file.url }}" type="audio/mpeg">
                                            </audio>
                                        </div>
                                    {% else %}
                                        <div class="media-preview" style="display:flex; align-items:center; justify-content:center; background:#e0e0e0; font-size:48px;" data-media-type="file">
                                            üìÑ
                                        </div>
                                    {% endif %}
                                {% endwith %}
                                <button class="media-delete-btn" data-media-id="{{ media.id }}" data-media-name="{{ media.title|default:media.file.name }}">√ó</button>
                            </div>
                            <div class="media-info">
                                <div class="media-title">{{ media.title|default:media.file.name }}</div>
                                <div class="media-date">{{ media.uploaded_at|date:"d.m.Y H:i" }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>H…ôl…ô he√ß bir media …ôlav…ô olunmayƒ±b.</p>
                    <p style="font-size:14px; margin-top:8px;">Yuxarƒ±dakƒ± "Import et" d√ºym…ôsi il…ô media fayllarƒ± …ôlav…ô edin.</p>
                </div>
            {% endif %}
        </div>
    </div>
    </div>
    </div>

    <!-- Fullscreen Modal -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <div class="fullscreen-content">
            <div class="fullscreen-close" id="fullscreenClose">√ó</div>
            <div id="fullscreenMedia"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3 style="margin:0 0 12px 0; font-size:18px;">Silm…ôk ist…ôdiyiniz…ô …ôminsiniz?</h3>
            <p style="margin:0; color:#666;" id="confirmText"></p>
            <div class="confirm-buttons">
                <button class="confirm-btn no" id="confirmNo">Yox</button>
                <button class="confirm-btn yes" id="confirmYes">B…ôli</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('media_files');
            const previewSection = document.getElementById('previewSection');
            const previewGrid = document.getElementById('previewGrid');
            const importBtn = document.getElementById('importBtn');
            const selectedFilesCount = document.getElementById('selectedFilesCount');
            let selectedFiles = [];

            function getFileExtension(filename) {
                return filename.toLowerCase().split('.').pop();
            }

            function isImageFile(filename) {
                const ext = getFileExtension(filename);
                return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
            }

            function isVideoFile(filename) {
                const ext = getFileExtension(filename);
                return ['mp4', 'avi', 'mov', 'webm'].includes(ext);
            }

            function isAudioFile(filename) {
                const ext = getFileExtension(filename);
                return ['mp3', 'wav', 'ogg'].includes(ext);
            }

            function createPreviewItem(file, index) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.index = index;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'preview-item-remove';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeFile(index);
                };

                let previewContent = '';
                const fileName = file.name;
                
                if (isImageFile(fileName)) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        previewItem.insertBefore(img, removeBtn);
                    };
                    reader.readAsDataURL(file);
                } else if (isVideoFile(fileName)) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const video = document.createElement('video');
                        video.src = e.target.result;
                        video.className = 'preview-video';
                        video.controls = true;
                        previewItem.insertBefore(video, removeBtn);
                    };
                    reader.readAsDataURL(file);
                } else if (isAudioFile(fileName)) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const audio = document.createElement('audio');
                        audio.src = e.target.result;
                        audio.controls = true;
                        audio.className = 'preview-audio';
                        previewItem.insertBefore(audio, removeBtn);
                    };
                    reader.readAsDataURL(file);
                } else {
                    const fileIcon = document.createElement('div');
                    fileIcon.className = 'preview-file';
                    fileIcon.innerHTML = 'üìÑ';
                    previewItem.insertBefore(fileIcon, removeBtn);
                }

                const filenameDiv = document.createElement('div');
                filenameDiv.className = 'preview-filename';
                filenameDiv.textContent = fileName;
                previewItem.appendChild(removeBtn);
                previewItem.appendChild(filenameDiv);

                return previewItem;
            }

            function removeFile(index) {
                selectedFiles.splice(index, 1);
                updateFileInput();
                updatePreview();
            }

            function updateFileInput() {
                const dataTransfer = new DataTransfer();
                selectedFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });
                fileInput.files = dataTransfer.files;
            }

            function updatePreview() {
                previewGrid.innerHTML = '';
                
                if (selectedFiles.length === 0) {
                    previewSection.classList.remove('active');
                    importBtn.style.display = 'none';
                    selectedFilesCount.style.display = 'none';
                    return;
                }

                previewSection.classList.add('active');
                importBtn.style.display = 'inline-flex';
                selectedFilesCount.style.display = 'block';
                selectedFilesCount.textContent = `${selectedFiles.length} fayl se√ßildi`;

                selectedFiles.forEach((file, index) => {
                    const previewItem = createPreviewItem(file, index);
                    previewGrid.appendChild(previewItem);
                });
            }

            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                
                // Yeni se√ßil…ôn fayllarƒ± …ôlav…ô et
                files.forEach(file => {
                    if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                        selectedFiles.push(file);
                    }
                });

                updatePreview();
            });

            // Form submit olduqda preview-i t…ômizl…ô
            document.getElementById('uploadForm').addEventListener('submit', function() {
                setTimeout(function() {
                    selectedFiles = [];
                    fileInput.value = '';
                    updatePreview();
                }, 100);
            });

            // Fullscreen Modal
            const fullscreenModal = document.getElementById('fullscreenModal');
            const fullscreenMedia = document.getElementById('fullscreenMedia');
            const fullscreenClose = document.getElementById('fullscreenClose');

            // Media item-l…ôrin…ô click event …ôlav…ô et
            document.querySelectorAll('.media-item-wrapper').forEach(function(wrapper) {
                const preview = wrapper.querySelector('.media-preview');
                if (!preview) return;
                
                preview.addEventListener('click', function(e) {
                    if (e.target.closest('.media-delete-btn')) return;
                    e.stopPropagation();
                    
                    const mediaType = preview.getAttribute('data-media-type');
                    let mediaUrl = preview.getAttribute('data-media-url');
                    
                    if (!mediaUrl) {
                        const img = preview.querySelector('img');
                        const source = preview.querySelector('source');
                        if (img) mediaUrl = img.src;
                        else if (source) mediaUrl = source.src;
                    }
                    
                    if (mediaType === 'image' && mediaUrl) {
                        fullscreenMedia.innerHTML = '<img src="' + mediaUrl + '" style="max-width:100%; max-height:90vh; object-fit:contain;">';
                        fullscreenModal.classList.add('active');
                    } else if (mediaType === 'video' && mediaUrl) {
                        fullscreenMedia.innerHTML = '<video controls autoplay style="max-width:100%; max-height:90vh;"><source src="' + mediaUrl + '" type="video/mp4"></video>';
                        fullscreenModal.classList.add('active');
                    }
                });
            });

            fullscreenClose.addEventListener('click', function(e) {
                e.stopPropagation();
                fullscreenModal.classList.remove('active');
            });

            fullscreenModal.addEventListener('click', function(e) {
                if (e.target === fullscreenModal) {
                    fullscreenModal.classList.remove('active');
                }
            });

            // Delete Media
            const confirmModal = document.getElementById('confirmModal');
            const confirmText = document.getElementById('confirmText');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            let deleteMediaId = null;

            document.querySelectorAll('.media-delete-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteMediaId = this.getAttribute('data-media-id');
                    const mediaName = this.getAttribute('data-media-name');
                    confirmText.textContent = 'Media "' + mediaName + '" silinsin?';
                    confirmModal.classList.add('active');
                });
            });

            confirmYes.addEventListener('click', function() {
                if (deleteMediaId) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/menu/' + deleteMediaId + '/delete/';
                    
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });

            confirmNo.addEventListener('click', function() {
                confirmModal.classList.remove('active');
                deleteMediaId = null;
            });

            confirmModal.addEventListener('click', function(e) {
                if (e.target === confirmModal) {
                    confirmModal.classList.remove('active');
                    deleteMediaId = null;
                }
            });

            // Notification System
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');

            function showNotification(message, isError) {
                notificationText.textContent = message;
                notification.className = 'notification' + (isError ? ' error' : '') + ' active';
                setTimeout(function() {
                    notification.classList.remove('active');
                }, 3000);
            }

            // Django messages-ƒ± g√∂st…ôr
            {% if messages %}
                {% for message in messages %}
                    showNotification('{{ message }}', {% if message.tags == 'error' %}true{% else %}false{% endif %});
                {% endfor %}
            {% endif %}
        });
    </script>
</body>
</html>

